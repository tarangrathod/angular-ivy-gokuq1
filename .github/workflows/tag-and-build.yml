name: Tag and Build Docker Container

on:
  push:
    branches:
      - main

jobs:
  tag-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Find commit message and tag version
      run: |
        COMMIT_MESSAGE=$(git log -1 --pretty=format:%s)
        TAG=$(echo "$COMMIT_MESSAGE" | grep -oP '(?<=#version:)[^\s]+')
        if [ -z "$TAG" ]; then
          echo "No version tag found in commit message"
          exit 1
        fi
        echo "Tagging commit with version $TAG"
        git tag -a "$TAG" -m "Version $TAG"
        git push origin "$TAG"

    - name: Build Docker image and tag with version
      if: success()
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKERHUB_USERNAME }}/gitaction:$TAG
