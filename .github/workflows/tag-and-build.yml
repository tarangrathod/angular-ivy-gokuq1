name: Create Tag and Build Docker Image

on:
  push:
    branches:
      - main

jobs:
  build-and-tag:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Parse Commit Message
      id: parse_commit_message
      run: echo ::set-output name=tag::$(grep -oP 'tag:VERSION=[0-9]\.[0-9]\.[0-9]' $GITHUB_EVENT_PATH || true)

    - name: Create Tag
      if: steps.parse_commit_message.outputs.tag != ''
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.MY_SECRET }}

      with:
        tag_name: ${{ steps.parse_commit_message.outputs.tag }}
        release_name: ${{ steps.parse_commit_message.outputs.tag }}
        body: |
          ${{ github.event.head_commit.message }}


    - name: Build Docker Image
      if: steps.parse_commit_message.outputs.tag != ''
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags: |
          github.DOCKERHUB_USERNAME/your-docker-repo:env.TAG_NAME 
          your-docker-registry/your-docker-repo:${{ steps.parse_commit_message.outputs.tag }}
        build-args: zxbuild
